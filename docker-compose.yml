services:
  # ---------------------------------------------------------
  # OPTIONAL: Stats for Strava Configuration Tool
  # ---------------------------------------------------------
  # The Stats for Strava Config Tool provides a web-based interface
  # for managing your Statistics for Strava configuration files.
  #
  # Features:
  #   - Visual form-based configuration editor (no YAML knowledge required)
  #   - Real-time validation to prevent configuration errors
  #   - YAML utilities for file management and validation
  #   - Optional SFS Console for executing Symfony commands
  #
  # Setup Instructions:
  #   1. Copy .env.example to .env (Docker Compose variables)
  #   2. Copy .env.config-tool.example to .env.config-tool (Authentication)
  #   3. Generate a secure SESSION_SECRET (see .env.config-tool.example)
  #   4. Start container: docker compose up -d config-manager
  #   5. Access at http://localhost:8092
  #
  # Documentation: https://github.com/dschoepel/stats-for-strava-config-tool
  # ---------------------------------------------------------
  
  config-manager:
    image: ghcr.io/dschoepel/stats-for-strava-config-tool:latest
    container_name: stats-for-strava-config-tool
    restart: unless-stopped

    # Note: Use a separate .env file for config-tool to avoid Docker Compose variable expansion warnings
    # The password hash contains $ characters which conflict with Docker Compose's ${VAR} syntax
    environment:
      - TZ=${TZ}
      - USERMAP_UID=${USERMAP_UID}
      - USERMAP_GID=${USERMAP_GID}
      - DEFAULT_STATS_CONFIG_PATH=${DEFAULT_STATS_CONFIG_PATH}
      - DEFAULT_GEAR_MAINTENANCE_PATH=${DEFAULT_GEAR_MAINTENANCE_PATH}
      - STATS_CMD_RUNNER_URL=${STATS_CMD_RUNNER_URL:-http://stats-cmd-runner:8080}

    volumes:
      - ./.env.config-tool:/app/.env  # Separate .env file with auth variables (must be writable)
      - ./config:/data/config  # Stats for Strava config directory
      - ./storage:/data/storage  # Gear maintenance images and other storage
      - ./logs:/data/logs  # Application and service logs
      - ./stats-cmd-logs:/var/log/stats-cmd/command-logs:rw  # Command execution logs (read-write for viewing)

    ports:
      - "8092:80"  # Access at http://localhost:8092

    networks:
      - statistics-for-strava-network

  # ---------------------------------------------------------
  # OPTIONAL: Stats Command Runner + Helper
  # ---------------------------------------------------------
  # Uncomment BOTH services below to enable the SFS Console.
  # 1. Uncomment both stats-cmd-runner and stats-cmd-helper services
  # 2. Enable "SFS Console" in Settings → User Interface Settings
  # 3. Restart the Docker stack: docker compose up -d
  # See README.md for more information.
  #
  # stats-cmd-runner:
  #   image: ghcr.io/dschoepel/stats-cmd-runner:latest
  #   container_name: stats-cmd-runner
  #   restart: unless-stopped
  #   working_dir: /var/www
  #   command: ["node", "server.js"]
  #   environment:
  #     - TZ=${TZ}
  #     - USERMAP_UID=${USERMAP_UID}
  #     - USERMAP_GID=${USERMAP_GID}
  #     - HELPER_URL=http://stats-cmd-helper:${STATS_CMD_HELPER_PORT:-8081}
  #   
  #   # ⚠️ IMPORTANT: console-commands.yaml Setup
  #   # This MUST be a FILE, not a directory, or containers will fail to start.
  #   # Create the file BEFORE starting containers:
  #   #
  #   # Linux/Mac:
  #   #   cp console-commands.yaml.example ./config/settings/console-commands.yaml
  #   #   sudo chown ${USERMAP_UID}:${USERMAP_GID} ./config/settings/console-commands.yaml
  #   #
  #   # Windows (Docker Desktop):
  #   #   copy console-commands.yaml.example ./config/settings/console-commands.yaml
  #   #
  #   # If this file doesn't exist, Docker will create a DIRECTORY instead, causing errors.
  #   # Log directories will be auto-created by Docker with correct ownership.
  #   
  #   volumes:
  #     - ./config/settings/console-commands.yaml:/var/www/console-commands.yaml:ro
  #     - ./stats-cmd-runner-logs:/var/log/stats-cmd-runner
  #   networks:
  #     - statistics-for-strava-network
  #   ports:
  #     - "8093:8080"
  #
  # stats-cmd-helper:
  #   image: ghcr.io/dschoepel/stats-cmd-helper:latest
  #   container_name: stats-cmd-helper
  #   restart: unless-stopped
  #   working_dir: /var/www
  #   command: ["node", "server.js"]
  #   environment:
  #     - TZ=${TZ}
  #     - PORT=${STATS_CMD_HELPER_PORT:-8081}
  #     - TARGET_CONTAINER=statistics-for-strava
  #     - COMMAND_LOGS_DIR=/var/log/stats-cmd/command-logs  # Must match volume mount path
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - ./config/settings/console-commands.yaml:/var/www/console-commands.yaml:ro
  #     - ./stats-cmd-logs:/var/log/stats-cmd/command-logs:rw  # Command execution logs (read-write)
  #   networks:
  #     - statistics-for-strava-network

networks:
  statistics-for-strava-network:
    driver: bridge
