services:
  config-manager:
    image: ghcr.io/dschoepel/stats-for-strava-config-tool:latest
    container_name: stats-for-strava-config-tool
    restart: unless-stopped

    # Note: Use a separate .env file for config-tool to avoid Docker Compose variable expansion warnings
    # The password hash contains $ characters which conflict with Docker Compose's ${VAR} syntax
    environment:
      - TZ=${TZ}
      - USERMAP_UID=${USERMAP_UID}
      - USERMAP_GID=${USERMAP_GID}
      - DEFAULT_STATS_CONFIG_PATH=${DEFAULT_STATS_CONFIG_PATH}
      - DEFAULT_GEAR_MAINTENANCE_PATH=${DEFAULT_GEAR_MAINTENANCE_PATH}
      - STRAVA_RUNNER_URL=${STRAVA_RUNNER_URL:-http://strava-runner:8080}

    volumes:
      - ./.env.config-tool:/app/.env  # Separate .env file with auth variables (must be writable)
      - ./statistics-for-strava/config:/data/config  # Stats for Strava config directory
      - ./statistics-for-strava/storage:/data/storage  # Gear maintenance images and other storage
      - ./statistics-for-strava/logs:/data/logs  # Application and service logs
      - ./strava-sh-logs:/var/log/strava-helper/command-logs:ro  # Command execution logs (read-only)

    ports:
      - "8092:80"  # Access at http://localhost:8092

    networks:
      - statistics-for-strava-network

  # ---------------------------------------------------------
  # OPTIONAL: Strava Runner + Command Helper
  # ---------------------------------------------------------
  # Uncomment BOTH services below to enable the SFS Console.
  # The runner validates commands; the helper executes them
  # inside the statistics-for-strava container via docker exec.
  #
  # strava-runner:
  #   image: ghcr.io/dschoepel/strava-runner:latest
  #   container_name: strava-runner
  #   restart: unless-stopped
  #   working_dir: /var/www
  #   command: ["node", "server.js"]
  #   environment:
  #     - TZ=${TZ}
  #     - USERMAP_UID=${USERMAP_UID}
  #     - USERMAP_GID=${USERMAP_GID}
  #     - HELPER_URL=http://strava-command-helper:${HELPER_PORT:-8081}
  #   volumes:
  #     - ./statistics-for-strava/config/settings/console-commands.yaml:/var/www/console-commands.yaml:ro
  #     - ./statistics-for-strava/runner-logs:/var/log/strava-runner
  #   networks:
  #     - statistics-for-strava-network
  #   ports:
  #     - "8093:8080"
  #
  # strava-command-helper:
  #   image: ghcr.io/dschoepel/strava-command-helper:latest
  #   container_name: strava-command-helper
  #   restart: unless-stopped
  #   working_dir: /var/www
  #   command: ["node", "server.js"]
  #   environment:
  #     - TZ=${TZ}
  #     - PORT=${HELPER_PORT:-8081}
  #     - TARGET_CONTAINER=statistics-for-strava
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - ./statistics-for-strava/config/settings/console-commands.yaml:/var/www/console-commands.yaml:ro
  #     - ./strava-sh-logs:/var/log/strava-helper/command-logs  # Command execution logs (read-write)
  #   networks:
  #     - statistics-for-strava-network

networks:
  statistics-for-strava-network:
    driver: bridge
