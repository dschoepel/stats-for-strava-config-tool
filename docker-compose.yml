services:
  config-manager:
    image: ghcr.io/dschoepel/stats-for-strava-config-tool:latest
    container_name: stats-for-strava-config-tool
    restart: unless-stopped

    # Note: Use a separate .env file for config-tool to avoid Docker Compose variable expansion warnings
    # The password hash contains $ characters which conflict with Docker Compose's ${VAR} syntax
    environment:
      - TZ=${TZ}
      - USERMAP_UID=${USERMAP_UID}
      - USERMAP_GID=${USERMAP_GID}
      - DEFAULT_STATS_CONFIG_PATH=${DEFAULT_STATS_CONFIG_PATH}
      - DEFAULT_GEAR_MAINTENANCE_PATH=${DEFAULT_GEAR_MAINTENANCE_PATH}
      - STATS_CMD_RUNNER_URL=${STATS_CMD_RUNNER_URL:-http://stats-cmd-runner:8080}

    volumes:
      - ./.env.config-tool:/app/.env  # Separate .env file with auth variables (must be writable)
      - ./statistics-for-strava/config:/data/config  # Stats for Strava config directory
      - ./statistics-for-strava/storage:/data/storage  # Gear maintenance images and other storage
      - ./statistics-for-strava/logs:/data/logs  # Application and service logs
      - ./stats-cmd-logs:/var/log/stats-cmd/command-logs:ro  # Command execution logs (read-only)

    ports:
      - "8092:80"  # Access at http://localhost:8092

    networks:
      - statistics-for-strava-network

  # ---------------------------------------------------------
  # OPTIONAL: Stats Command Runner + Helper
  # ---------------------------------------------------------
  # Uncomment BOTH services below to enable the SFS Console.
  # 1. Uncomment both stats-cmd-runner and stats-cmd-helper services
  # 2. Enable "SFS Console" in Settings â†’ User Interface Settings
  # 3. Restart the Docker stack: docker compose up -d
  # See README.md for more information.
  #
  # stats-cmd-runner:
  #   image: ghcr.io/dschoepel/stats-cmd-runner:latest
  #   container_name: stats-cmd-runner
  #   restart: unless-stopped
  #   working_dir: /var/www
  #   command: ["node", "server.js"]
  #   environment:
  #     - TZ=${TZ}
  #     - USERMAP_UID=${USERMAP_UID}
  #     - USERMAP_GID=${USERMAP_GID}
  #     - HELPER_URL=http://stats-cmd-helper:${HELPER_PORT:-8081}
  #   volumes:
  #     - ./statistics-for-strava/config/settings/console-commands.yaml:/var/www/console-commands.yaml:ro
  #     - ./statistics-for-strava/stats-cmd-runner-logs:/var/log/stats-cmd-runner
  #   networks:
  #     - statistics-for-strava-network
  #   ports:
  #     - "8093:8080"
  #
  # stats-cmd-helper:
  #   image: ghcr.io/dschoepel/stats-cmd-helper:latest
  #   container_name: stats-cmd-helper
  #   restart: unless-stopped
  #   working_dir: /var/www
  #   command: ["node", "server.js"]
  #   environment:
  #     - TZ=${TZ}
  #     - PORT=${HELPER_PORT:-8081}
  #     - TARGET_CONTAINER=statistics-for-strava
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - ./statistics-for-strava/config/settings/console-commands.yaml:/var/www/console-commands.yaml:ro
  #     - ./stats-cmd-logs:/var/log/stats-cmd/command-logs  # Command execution logs (read-write)
  #   networks:
  #     - statistics-for-strava-network

networks:
  statistics-for-strava-network:
    driver: bridge
